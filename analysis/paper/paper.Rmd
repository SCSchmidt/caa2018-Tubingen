---
title: "Reproducible research in archaeology using R & rrtools"
author:
  - Sophie C. Schmidt
  - Ben Marwick
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
      number_sections: false
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r, setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  comment = "#>",
  fig.path = "../figures/"
)

library(caa2018) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory

library(ggrepel)
library(tidyverse)
```

## Introduction

These are our notes for preparing our slides for our CAA2018 presentation in the session "R as an archaeological tool: current state and directions" (https://github.com/MartinHinz/isaak_conf_sessions/tree/master/caa_2018_tuebingen)

## What are the top archaeology journals by number of papers published?

We need to know this to plan for the data collection for our JCCA paper, it's not central to our CAA presentation, but I've put it here so I know where to find it later (I hope).

Data are from an 'advanced search' of apps.webofknowledge.com using WC=Archaeology on apps.webofknowledge.com.

For 2017 only:

```{r}
wc_archaeology_2017 <- 
  readr::read_tsv(paste0(here::here(), "/analysis/data/raw_data/savedrecs.txt"), 
            quote = "")
```

```{r top-archaeology-journals-by-articles}
# The 10 journals with the most articles are:

top_journals_by_articles <- 
wc_archaeology_2017 %>% 
  group_by(SO) %>% 
  tally(sort = TRUE) 

knitr::kable(head(top_journals_by_articles, 10), 
             caption = "The top 10 archaeology journals, by number of papers published in 2017")
```

For 2007-2017:

```{r}
library(glue)

data_files_from_2007_to_2017 <- 
  paste0(here::here(), glue("/analysis/data/raw_data/savedrecs ({1:2}).txt"))
```

```{r fig.height=10}

wc_archaeology_2007_to_2017 <- 
  map(data_files_from_2007_to_2017,
      ~readr::read_tsv(.x, quote = "")) %>% 
  bind_rows()

# most popular journals over time
most_popular_journals_over_time <- 
wc_archaeology_2007_to_2017 %>% 
  group_by(SO, PY) %>% 
  tally(sort = TRUE) %>% 
  filter(n >= 50) %>% 
  ungroup()

ggplot(most_popular_journals_over_time,
       aes(PY, 
           n,
           colour = SO)) +
  geom_line() +
  geom_text_repel(
    data = subset(most_popular_journals_over_time, 
                  PY == max(PY)),
    aes(label = SO),
    size = 3,
    nudge_x = 15,
    segment.color = NA
  ) +
  xlim(2007, 2019) +
  theme_minimal() +
  theme(legend.position="none") +
  ggtitle("Number of articles per year in Archaeology journals",
          subtitle = "Data from apps.webofknowledge.com,\nusing WC=Archaeology in SCI-EXPANDED & SSCI for 2007-2017")
```

## Citations of R Core in articles on Web of Science

We wanted to to see how R Core is cited in scientific literature in general, and in archaeology in particular.

We did a 'Cited Reference Search' in WoS for title "R: A Language and Environment for Statistical Computing" and author = "R Core Team", which is the output from  `citation()`. This function first appeared in 2004 https://github.com/wch/r-source/commits/9a5c086855d2e8fb07f670e3315871b2de31a4fd/src/library/base/inst/CITATION 

Note that before 2012 the authors were "R Development Core Team", and then it was simplified to "R Core Team" https://github.com/wch/r-source/commit/9a5c086855d2e8fb07f670e3315871b2de31a4fd#diff-80bb8a8b133a6204e9642d76791927e2

This is our exact search string for WoS:

You searched for: CITED AUTHOR: ("R DEV COR TEAM" OR "R CORE" OR "R CORE TEAM") AND CITED WORK: ("R: A Language and Environment for Statistical Computing") AND LANGUAGE: (English) AND DOCUMENT TYPES: (Article)
Timespan: All years. Indexes: SCI-EXPANDED, SSCI, A&HCI, ESCI.

For all scientific journals tracked by the WoS:

```{r}

cran_cites_files <- 
    paste0(here::here(), glue("/analysis/data/raw_data/cited_cran/savedrecs ({1:11}).txt"))
```

```{r fig.height=10}
cran_cites_all_areas_all_years <- 
  map(cran_cites_files,
      ~readr::read_tsv(.x, 
                       quote = "",
                       col_types = cols(.default = col_character()))) %>% 
  bind_rows() %>% 
  mutate(PY = as.numeric(PY)) %>% 
  filter(PY <= 2017)

# limit to top journals
top_journals_for_cran_cites <- 
  cran_cites_all_areas_all_years %>% 
  group_by(SO) %>% 
  tally(sort = TRUE)

# tally by year
cran_cites_all_areas_top_journals_by_year <- 
  cran_cites_all_areas_all_years %>% 
  filter(SO %in% top_journals_for_cran_cites$SO[1:10]) %>% 
  group_by(SO, PY) %>% 
  tally(sort = TRUE) %>% 
  ungroup() 

ggplot(cran_cites_all_areas_top_journals_by_year,
       aes(PY,
           n,
           colour = SO)) +
  geom_line() +
  geom_text_repel(
    data = subset(cran_cites_all_areas_top_journals_by_year, 
                  PY == max(PY)),
    aes(label = str_wrap(SO, 15)),
    size = 3,
    direction = "both",
    nudge_x = 1,
    segment.color = NA
  ) +
  xlim(2007, 2018) +
  theme_minimal() +
  theme(legend.position="none") +
  ggtitle("Number of articles per year citing R Core in top 10 WoS journals",
          subtitle = "Data from apps.webofknowledge.com,\nusing in SCI-EXPANDED & SSCI for 2007-2017")
```

For archaeology journals only:

```{r}

cran_cites_in_archy_journals <- 
  cran_cites_all_areas_all_years %>% 
  filter(SO %in% top_journals_by_articles$SO)

cran_cites_in_archy_journals_per_year <- 
  cran_cites_in_archy_journals %>% 
  group_by(SO, PY) %>% 
  tally(sort = TRUE) %>% 
  ungroup() %>% 
  mutate(PY = as.numeric(PY)) 

ggplot(cran_cites_in_archy_journals_per_year,
       aes(PY,
           n,
           colour = SO)) +
  geom_line() +
  geom_text_repel(
    data = subset(cran_cites_in_archy_journals_per_year, 
                  PY == max(PY)),
    aes(label = str_wrap(SO, 10)),
    size = 3,
    nudge_x = 1,
    segment.color = NA
  ) +
  xlim(2007, 2019) +
  theme_minimal() +
  theme(legend.position="none") +
  ggtitle("Number of Archaeology articles per year citing R Core",
          subtitle = "Data from apps.webofknowledge.com,\nusing in SCI-EXPANDED & SSCI for 2007-2017")
```


## Text mining titles in archaeology journal articles that cite R Core

What are the key words in the titles of these archaeology articles that cite R Core, and how do they differ from other archaeology articles?


```{r}
library(tidytext)
# https://www.tidytextmining.com/twitter.html

# These are all archy articles
# wc_archaeology_2007_to_2017

# These are ones citing R
# cran_cites_in_archy_journals

# subtract ones citing R from ones that do not
library(Hmisc)
wc_archaeology_2007_to_2017_no_R_cites <- 
  wc_archaeology_2007_to_2017 %>% 
  filter(TI %nin% cran_cites_in_archy_journals$TI)

# combine
archy_journal_articles <- 
  bind_rows(wc_archaeology_2007_to_2017_no_R_cites %>% 
            mutate(ID = "no_R_cites",
                   VL = as.character(VL)),
           cran_cites_in_archy_journals %>% 
            mutate(ID = "has_R_cites"))

library(tidytext)
library(stringr)

tidy_cites <- 
archy_journal_articles %>% 
  unnest_tokens(word, TI) %>%
  filter(!word %in% stop_words$word,
         str_detect(word, "[a-z]"))

frequency <- 
  tidy_cites %>% 
  group_by(ID) %>% 
  count(word, sort = TRUE) %>% 
  left_join(tidy_cites %>% 
              group_by(ID) %>% 
              summarise(total = n())) %>%
  mutate(freq = n/total)

frequency <- frequency %>% 
  select(ID, word, freq) %>% 
  spread(ID, freq) %>%
  arrange(no_R_cites, has_R_cites)

library(scales)

ggplot(frequency, 
       aes(no_R_cites, 
           has_R_cites)) +
  geom_jitter(alpha = 0.1, 
              size = 2.5, 
              width = 0.25, 
              height = 0.25) +
  geom_text(aes(label = word), 
            check_overlap = TRUE, 
            vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  geom_abline(color = "red")

word_ratios <- tidy_cites %>%
  count(word, ID) %>%
  filter(sum(n) >= 10) %>%
  ungroup() %>%
  spread(ID, n, fill = 0) %>%
  mutate_if(is.numeric, funs((. + 1) / sum(. + 1))) %>%
  mutate(logratio = log(has_R_cites / no_R_cites)) %>%
  arrange(desc(logratio))

word_ratios %>%
  group_by(logratio < 0) %>%
  top_n(10, abs(logratio)) %>%
  ungroup() %>%
  mutate(word = reorder(word, logratio)) %>%
  ggplot(aes(word, logratio, fill = logratio < 0)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  ylab("log odds ratio (has_R_cites/no_R_cites)") +
  scale_fill_discrete(name = "", labels = c("has_R_cites", "no_R_cites"))


```



# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
git2r::repository("../..")
```
